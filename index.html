<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telegram Reward Mini App â€“ Profile + Referral</title>  <!-- Telegram Webâ€‘App JS -->  <script src="https://telegram.org/js/telegram-web-app.js"></script>  <!-- Firebase v9 compat -->  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>  <style>
    :root { --brand:#006eff }
    *{box-sizing:border-box;font-family:system-ui,sans-serif}
    body{margin:0;padding:2rem;text-align:center}
    button{background:var(--brand);border:none;color:#fff;padding:.8rem 1.4rem;border-radius:8px;font-size:1rem;cursor:pointer}
    #coin{font-size:1.3rem;margin:1rem 0}
    #videoWrap{margin-top:1.2rem;display:none}
    video{width:100%;max-height:60vh;border:2px solid var(--brand);border-radius:12px}
    #title{margin:.5rem 0;font-weight:600}
    #ref{margin-top:0.5rem;font-size:.9rem}
    #ref a{color:var(--brand);word-break:break-all}
  </style></head>
<body>
  <h2>ğŸ Earn Coins by Watching Video</h2>
  <div id="user" hidden>
    Logged in as <span id="userName"></span>
  </div>
  <div id="coin">Coins: 0</div>
  <p id="ref" style="display:none;">Referral link: <a id="refLink" target="_blank"></a></p>
  <button id="login">ğŸ”‘ Signâ€‘in with Google</button>  <div id="videoWrap">
    <div id="title"></div>
    <video id="rewardVideo" controls></video>
    <p>Watch the full video to earn 1 coin.</p>
  </div><script>
/**************** 1) Firebase ****************/
const firebaseConfig={
  apiKey:"AIzaSyDuZHkVHWZbJSYAeE7iC1ZCaw4gOlvtz88",
  authDomain:"rewardminiapp.firebaseapp.com",
  projectId:"rewardminiapp",
  storageBucket:"rewardminiapp.firebasestorage.app",
  messagingSenderId:"141140205968",
  appId:"1:141140205968:web:4bfd0454e624f807cd5315",
  measurementId:"G-02K7J27PL9"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();

/**************** 2) Telegram helpers ****************/
const tg=window.Telegram?.WebApp;tg?.ready();tg?.expand();

/**************** 3) Constants ****************/
const BOT_USERNAME='Ghuri_bot'; // change if your bot user differs

/**************** 4) Coin helpers ****************/
const coinEl=document.getElementById('coin');
const uidKey=()=>`coins_${auth.currentUser?.uid||'anon'}`;
const getCoins=()=>parseInt(localStorage.getItem(uidKey())||'0',10);
const setCoins=c=>{localStorage.setItem(uidKey(),c);coinEl.textContent='Coins: '+c;};
setCoins(getCoins());

/**************** 5) HTML refs ****************/
const loginBtn=document.getElementById('login');
const userBox=document.getElementById('user');
const userNameSpan=document.getElementById('userName');
const refWrap=document.getElementById('ref');
const refLinkEl=document.getElementById('refLink');
const videoWrap=document.getElementById('videoWrap');
const videoEl=document.getElementById('rewardVideo');
const titleEl=document.getElementById('title');

/**************** 6) Google Login (Redirect) ****************/
loginBtn.onclick=()=>{
  const provider=new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithRedirect(provider);
};

firebase.auth().getRedirectResult().then(handleLogin).catch(err=>alert('Login failed: '+err.message));

auth.onAuthStateChanged(handleLogin);

function handleLogin(res){
  const user=res?.user||res;
  if(!user||!user.uid) return;
  userNameSpan.textContent=user.displayName||user.email;
  userBox.hidden=false;
  loginBtn.style.display='none';
  // show coins for logged user
  setCoins(getCoins());
  // set referral link
  const link=`https://t.me/${BOT_USERNAME}?start=${user.uid}`;
  refLinkEl.href=link;
  refLinkEl.textContent=link;
  refWrap.style.display='block';
  // load videos once
  loadVideoList();
}

/**************** 7) Load video list ****************/
const JSON_URL='videos.json';
let playlist=[];
async function loadVideoList(){
  if(playlist.length) return; // already loaded
  try{
    const res=await fetch(JSON_URL);
    const data=await res.json();
    playlist=data.videos||[];
    chooseVideo();
  }catch(e){console.error('videos.json load error',e);tg?.showAlert?.('Could not load videos');}
}
function chooseVideo(){
  if(!playlist.length){tg?.showAlert?.('No video available');return;}
  const unviewed=playlist.filter(v=>!localStorage.getItem(rewardKey(v.url)));
  const vid=unviewed.length?unviewed[Math.floor(Math.random()*unviewed.length)]
                          :playlist[Math.floor(Math.random()*playlist.length)];
  titleEl.textContent=vid.title;
  videoEl.src=vid.url;videoEl.load();
  videoEl.dataset.currentUrl=vid.url;
  videoEl.dataset.rewarded='';
  videoWrap.style.display='block';
}
function rewardKey(url){return`rewarded_${auth.currentUser.uid}_${url}`;}

/**************** 8) Reward logic ****************/
videoEl.addEventListener('ended',()=>{
  const user=auth.currentUser;if(!user){tg?.showAlert?.('Please signâ€‘in first');return;}
  const url=videoEl.dataset.currentUrl;const key=rewardKey(url);
  if(localStorage.getItem(key)){tg?.showAlert?.('Reward already claimed for this video');return;}
  const coins=getCoins()+1;setCoins(coins);localStorage.setItem(key,'1');videoEl.dataset.rewarded='1';
  tg?.showAlert?.(`ğŸ‰ You earned 1 coin! Total: ${coins}`);
});
</script></body>
</html>
